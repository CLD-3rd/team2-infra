prometheus:
  prometheusSpec:
    # ë¦¬ì†ŒìŠ¤ ì œí•œ ì„¤ì •
    resources:
      requests:
        memory: 400Mi
        cpu: 100m
      limits:
        memory: 2Gi
        cpu: 1000m
    
    # ë°ì´í„° ë³´ì¡´ ê¸°ê°„
    retention: 15d
    
    # ìŠ¤í† ë¦¬ì§€ ì„¤ì •
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: gp2
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 5Gi
    
    # ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„° ì…€ë ‰í„° ì„¤ì •
    # HelmValuesì— ìˆëŠ”ê²ƒë§Œ í•˜ì§€ ì•Šê³  ì¶”ê°€ì ìœ¼ë¡œ ì„ íƒí•˜ê² ë‹¤.
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    
    # ì¶”ê°€ ìŠ¤í¬ë© ì„¤ì •
    additionalScrapeConfigs:
    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - default
          - dev
          - prod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      metrics_path: /actuator/prometheus
    # ì¶”ê°€ ê·œì¹™
    additionalPrometheusRulesMap:
      springboot-critical-alerts:
        groups:
          - name: springboot-alert-rules
            interval: 30s
            rules:
              - alert: HighCPUUsage
                expr: |
                  (
                    sum(rate(container_cpu_usage_seconds_total{namespace="default", pod=~".*"}[5m])) by (pod)
                    /
                    sum(kube_pod_container_resource_limits{namespace="default", resource="cpu"}) by (pod)
                  ) * 100 > 70
                for: 5m
                labels:
                  severity: warning
                  component: spring-boot
                annotations:
                  summary: "ğŸ”§ ë†’ì€ CPU ì‚¬ìš©ë¥  ê°ì§€"
                  description: "Pod {{ $labels.pod }}ì˜ CPU ì‚¬ìš©ë¥ ì´ {{ $value | humanize }}%ì…ë‹ˆë‹¤. (ì„ê³„ê°’: 70%)"
              - alert: CriticalMemoryUsage
                expr: |
                  (
                    sum(container_memory_working_set_bytes{namespace="default"}) by (pod)
                    /
                    sum(kube_pod_container_resource_limits{namespace="default", resource="memory"}) by (pod)
                  ) * 100 > 95
                for: 2m
                labels:
                  severity: critical
                  component: spring-boot
                annotations:
                  summary: "ğŸš¨ ë©”ëª¨ë¦¬ ë¶€ì¡± ìœ„í—˜"
                  description: "Pod {{ $labels.pod }}ì˜ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ì´ {{ $value | humanize }}%ì…ë‹ˆë‹¤. (ì„ê³„ê°’: 95%)"
              - alert: AppDown
                expr: up{job=~"spring-boot-.*"} == 0
                for: 2m
                labels:
                  severity: critical
                  component: spring-boot
                annotations:
                  summary: "ğŸ”´ Spring Boot ì•± ì‘ë‹µ ì—†ìŒ"
                  description: "{{ $labels.instance }} ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì•±ì´ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (up == 0)."
              - alert: PodRestartingTooOften
                expr: increase(kube_pod_container_status_restarts_total{namespace="default"}[1h]) > 3
                for: 5m
                labels:
                  severity: warning
                  component: spring-boot
                annotations:
                  summary: "â™»ï¸ Pod ì¬ì‹œì‘ ë¹ˆë„ ë†’ìŒ"
                  description: "Pod {{ $labels.pod }}ê°€ ìµœê·¼ 1ì‹œê°„ ë™ì•ˆ {{ $value }}íšŒ ì¬ì‹œì‘í–ˆìŠµë‹ˆë‹¤."

  
  service:
    type: LoadBalancer
    annotations:
      external-dns.alpha.kubernetes.io/hostname: prometheus.savemypodo.shop
      service.beta.kubernetes.io/aws-load-balancer-scheme: internal

grafana:
  serviceAccount:
    create: true
    name: prometheus-stack-grafana
    annotations:
      eks.amazonaws.com/role-arn: arn:aws:iam::061039804626:role/savemypodo-cluster-grafana # IAM Role ARN ì„¤ì •

  # ì„œë¹„ìŠ¤ íƒ€ì… ì„¤ì •
  service:
    type: LoadBalancer
    annotations:
      external-dns.alpha.kubernetes.io/hostname: grafana.savemypodo.shop
      service.beta.kubernetes.io/aws-load-balancer-scheme: internal

  # ë¦¬ì†ŒìŠ¤ ì„¤ì •
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi
  
  # ì˜êµ¬ ìŠ¤í† ë¦¬ì§€
  persistence:
    enabled: true
    storageClassName: gp2 # EKSì˜ ê¸°ë³¸ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ì‚¬ìš©
    accessModes:
      - ReadWriteOnce
    size: 5Gi

alertmanager:
  config:
    global:
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'michelle200323@gmail.com'
      smtp_auth_username: 'michelle200323@gmail.com'
      smtp_auth_password:
        valueFrom:
          secretKeyRef:
            name: alertmanager-smtp-secret
            key: smtp_auth_password
      smtp_require_tls: true

    route:
      group_by: ['alertname']
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 1h
      receiver: 'default-email'
      routes:
        - match:
            alertname: HighCPUUsage
          receiver: 'cpu-alert-email'
        - match:
            alertname: CriticalMemoryUsage
          receiver: 'memory-alert-email'
        - match:
            alertname: AppDown
          receiver: 'appdown-alert-email'
        - match:
            alertname: PodRestartingTooOften
          receiver: 'pod-restart-alert-email'

    receivers:
      - name: 'default-email'
        email_configs:
          - to: 'fallback@yourdomain.com'
            send_resolved: true
            html: |
              <p>âš ï¸ ê¸°ë³¸ ì•ŒëŒì…ë‹ˆë‹¤</p>
              <p>{{ .CommonAnnotations.summary }}</p>
              <p>{{ .CommonAnnotations.description }}</p>

      - name: 'cpu-alert-email'
        email_configs:
          - to: 'cpu-team@yourdomain.com'
            send_resolved: true
            html: |
              <h3>ğŸ”¥ CPU ì‚¬ìš©ë¥  ê²½ê³ </h3>
              <p>ğŸ“Œ Alert: {{ .CommonLabels.alertname }}</p>
              <p>ğŸš¨ Pod: {{ index .CommonLabels "pod" }}</p>
              <p>ğŸ’¬ ìš”ì•½: {{ .CommonAnnotations.summary }}</p>
              <p>ğŸ“– ìƒì„¸: {{ .CommonAnnotations.description }}</p>

      - name: 'memory-alert-email'
        email_configs:
          - to: 'memory-team@yourdomain.com'
            send_resolved: true
            html: |
              <h3>ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ì‹¬ê°</h3>
              <p>ğŸ“Œ Alert: {{ .CommonLabels.alertname }}</p>
              <p>ğŸ§  Pod: {{ index .CommonLabels "pod" }}</p>
              <p>{{ .CommonAnnotations.description }}</p>

      - name: 'appdown-alert-email'
        email_configs:
          - to: 'ops-team@yourdomain.com'
            send_resolved: true
            html: |
              <h3>ğŸŸ¥ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ìš´</h3>
              <p>ì¸ìŠ¤í„´ìŠ¤: {{ .CommonLabels.instance }}</p>
              <p>{{ .CommonAnnotations.description }}</p>

      - name: 'pod-restart-alert-email'
        email_configs:
          - to: 'dev-team@yourdomain.com'
            send_resolved: true
            html: |
              <h3>â™»ï¸ Pod ì¬ì‹œì‘ ê³¼ë‹¤</h3>
              <p>Pod: {{ index .CommonLabels "pod" }}</p>
              <p>{{ .CommonAnnotations.description }}</p>

    
  service:
    type: LoadBalancer
    annotations:
      external-dns.alpha.kubernetes.io/hostname: alertmanager.savemypodo.shop
      service.beta.kubernetes.io/aws-load-balancer-scheme: internal

# Node Exporter ì„¤ì •
nodeExporter:
  enabled: true

# Kube State Metrics ì„¤ì •
kubeStateMetrics:
  enabled: true
